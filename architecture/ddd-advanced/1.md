以下の質問に回答してください

## 課題1-1

「ログインしているユーザしか投稿できない」機能を備えた掲示板サービスがあるとしましょう。例えば以下のようなコードでアクセスを制御しているとします。

```jsx
if (user.isLoggedIn) {
  // 投稿できる
} else {
  // 投稿できない
}
```

このようなアクセス制御ロジックはオニオンアーキテクチャのどの層に実装するべきでしょうか？（アプリケーション（ユースケース）層、ドメイン層、インフラ層など・・・）

- ユースケース層で実装する
  - ユーザーのログイン、未ログインの状態の判定はドメインにある
    - 分岐のなかでログイン状態ならINSERT系のクエリ、投稿できないならその内容をユーザーに伝えるなどを実装される
  - ドメインの状態をもとにシステム的な振る舞いを変更するのであれば、ユースケース層で実装すべきと考える

## 課題1-2

上記のケースではuserオブジェクトにisLoggedInという属性が付与されています。フロントエンドから送られてきたtokenなどを見て、isLoggedInをtrueにするコードがどこかにあるはずです。例えば以下のような疑似コードです。

```
const token = req.token
const isValidToken = firebaseService.validateToken(token)
const user = new User(isValidToken) // isLoggedInがtrueになるようなuserが作成されるイメージ
```

このようなロジックはオニオンアーキテクチャで言うところの、どの層に実装するべきでしょうか？

- インフラストラクチャ層 (Controller)
  - tokenが req.tokenになっており、APIへのリクエスト前提になっている
  - api層がService層のメソッドを呼び出すという関係性になっているため

## 課題1-3

複数の集約をまたいで整合性を担保したいケースを考えてみましょう。

「タスク」と「活動レポート」二つの集約の整合性を保つ必要があるケースを想定してみます。例えば「タスク」と「活動レポート」の集約があり、タスクを作成したら必ず「タスクを作成しました」と活動レポートを作成しなければいけないとします（[こちらのブログから拝借](https://little-hands.hatenablog.com/entry/2021/03/08/aggregation)）。

どのように実装すれば、複数集約の整合性が担保されると思いますか？

- イベントの記録をわけてあげる... 3の選択肢
  - タスクが作成されたら、活動レポートを作成するということは必須だが、それが完全に同時である必要がない
  - 必須の要件を確実に満たすようにタスクを作成したら、そのイベントを作成して、イベントを拾うように実装してあげたほうが確実性が得られると思う
  - この構成の場合は、イベントの記録に一旦失敗しても、リトライなどの復旧がやりやすいということがある
  - 1ではトランザクションをいちいち意識しないといけないので、面倒。意識しなくていいなら、しないほうが楽
  - 2では責務があいまいになりやすいというデメリットが見えているので、一度あいまいになったものを戻すのが大変になりやすいとおもうから


## 課題1-4

ブログを投稿できるWEBサービスで、Userエンティティに「name」や「avatarImage」など、マイページで表示される情報がプロパティとして定義されている状態を想定してください。

上記のUserエンティティに「emailAddress」や「firebaseUserId」など、認証に関わるような情報を格納するPRが提出されました。これらの情報はドメインロジックとして使うものではなく、純粋に認証のためだけに使われるプロパティです。

果たしてUserエンティティに上記のようなプロパティを増やすことに問題はないのでしょうか？ペアで議論してみてください。

- ドメインモデルとして、関係ないものはいれてはいけないと考える
  - 認証というコンテキストのなかでは必要かもしれないが、マイページに表示するというマイページのユーザーというコンテキストだと必要のないもの
  　- メールアドレスをマイページに表示するなら、メールアドレスは追加してもいいかもしれないけど
  - 認証のためだけに使用するのであれば、別の専門のオブジェクトを用意してあげるべき

## 課題1-5

ブログを投稿できるWEBサービスで、ブログの文字数が上限の1000文字を超えたらエラーが生じるようにしたいと考えました。とあるエンジニアが以下のようなコードを提出しました。

```
class Post {
  constructor(text) {
    if (text.length > 1000) {
      throw new Error('blog post too long!')
    }
    this.text = text
  }
}
```

文字数の上限を超えた際にエラーをthrowすることに関して、どのような問題が起き得ると思いますか？

- ブログの下書きなどが消えうる。例外発生したときに、そのtextの内容をどこかで保管していなければ、完成品が一から書き直しとかになってしまう可能性がある
- すでに1000文字を超えるブログがあった場合に表示できずにエラーになってしまう
  - ブログデータの保管先からデシリアライズする際に、Postコンストラクタの制限にひっかかってエラーになり表示できなくなる
