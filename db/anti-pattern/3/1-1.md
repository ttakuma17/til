# ポリモーフィック関連のアンチパターンに関する整理

## 1. 前提
- テーブル設計において、「どのようにテーブルを分けるか」「どのカラムにどの情報を格納するか」を考える。
- 特に、コメントを管理する `Comment` テーブルの設計が課題となる。

## 2. アンチパターンの名前
- **ポリモーフィック関連（Polymorphic Association）**
  - 一つのテーブル（`Comment` テーブル）が複数の異なる親テーブル（例：`Manga`、`Novel`）を参照する設計。

## 3. アンチパターンによる問題
### テーブル肥大化
- `Comment` テーブルにすべてのコメントを格納するため、書籍の種類が増えると `Comment` テーブルがどんどん大きくなる。

### スキーマ変更の影響
- `Comment` に新しい項目を追加すると、すべての書籍（`Manga`、`Novel` など）に対してその変更が影響する。

### `belongs_to_id` が複数の意味を持つ
- 適切に正規化されていれば何の ID か明確になるはずだが、この設計では `belongs_to_id` の意味が曖昧になる。
- `type` カラムを指定しないと SQL を正しく実行できず、アプリケーション側で余計なロジックが増える。
- `Comment` テーブルを基準に `JOIN` しないといけないため、パフォーマンスが `Comment` テーブルに依存する。

### `type` カラムの不要性
- `belongs_to_id` の意味が不明確なため、本来不要な `type` カラムが必要になってしまっている。

### 設計の影響範囲が広がる
- 書籍にタグをつける場合にも `Comment` テーブルの設計に引きずられて、タグの管理も同じポリモーフィックな方法で設計する可能性が高くなる。

### 外部キー制約の適用不可
- `belongs_to_id` に外部キー制約を付けたいが、親テーブルが2つ以上あるため制約を設定できない。
- その結果、データの整合性を保証できなくなる。

## 4. アンチパターンを使うことを許容する条件
- ポリモーフィックなテーブルにすることで、クエリを複雑にしたくない場合のみ許容されることがある。

## 5. 参考文献
- https://qiita.com/dai329/items/1db8fbe37f43a465d801
- https://zenn.dev/keishi815/articles/7bb65d09253d4e
- https://zenn.dev/socialplus/articles/136a5a05b33a35
- https://techblog.gmo-ap.jp/2021/06/23/sql-antipattern-1/
